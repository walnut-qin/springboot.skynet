<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kaos.his.mapper.credential.EscortMapper">
    <resultMap id="resultMap" type="com.kaos.his.entity.credential.EscortCard">
        <result column="ESCORT_NO" jdbcType="VARCHAR" property="escortNo"/>
        <result column="IS_VIP" jdbcType="VARCHAR" property="vip"/>
        <association columnPrefix="HOS_CTF_" resultMap="com.kaos.his.mapper.credential.HospitalizationCertificateMapper.map" javaType="com.kaos.his.entity.credential.PreinCard" property="hospitalizationCertificate"/>
        <association columnPrefix="PAT_" resultMap="com.kaos.his.mapper.personnel.PatientMapper.map" javaType="com.kaos.his.entity.personnel.Patient" property="helper"/>
        <collection column="{escortNo=ESCORT_NO}" select="GetEscortStates" ofType="com.kaos.his.entity.credential.EscortCard$EscortState" property="states"/>
        <collection column="{escortNo=ESCORT_NO}" select="GetEscortActions" ofType="com.kaos.his.entity.credential.EscortCard$EscortAction" property="actions"/>
    </resultMap>

    <resultMap id="escortStateMap" type="com.kaos.his.entity.credential.EscortCard$EscortState">
        <result column="REC_NO" jdbcType="VARCHAR" property="recNo"/>
        <result column="STATE" jdbcType="VARCHAR" property="state"/>
        <result column="OPER_DATE" jdbcType="VARCHAR" property="operDate"/>
    </resultMap>

    <resultMap id="escortActionMap" type="com.kaos.his.entity.credential.EscortCard$EscortAction">
        <result column="REC_NO" jdbcType="VARCHAR" property="recNo"/>
        <result column="ACTION" jdbcType="VARCHAR" property="action"/>
        <result column="OPER_DATE" jdbcType="VARCHAR" property="operDate"/>
    </resultMap>

    <select id="GetEscort" resultMap="resultMap">
        SELECT
            T1.ESCORT_NO AS ESCORT_NO,
            T1.PATIENT_CARD_NO AS HOS_CTF_CARD_NO,
            T1.HAPPEN_NO AS HOS_CTF_HAPPEN_NO,
            T2.OPER_DATE AS HOS_CTF_OPER_DATE,
            T2.NURSE_CELL_CODE AS HOS_CTF_PRE_NURSE_CELL_CODE,
            T2.BED_NO AS HOS_CTF_PRE_BED_NO,
            T2.PRE_DATE AS HOS_CTF_PRE_DATE,
            T2.PREPAY_COST AS HOS_CTF_PRE_COST,
            T2.PRE_STATE AS HOS_CTF_STATE,
            T2.OPER_CODE AS HOS_CTF_OPER_CODE,
            T3.EMPL_NAME AS HOS_CTF_OPER_NAME,
            T3.SEX_CODE AS HOS_CTF_OPER_SEX,
            T3.BIRTHDAY AS HOS_CTF_OPER_BIRTHDAY,
            T3.IDENNO AS HOS_CTF_OPER_IDENTITY_NO,
            T3.TEL AS HOS_CTF_OPER_PHONE_NO,
            T3.EMAIL AS HOS_CTF_OPER_EMAIL,
            T3.DEPT_ID AS HOS_CTF_OPER_DEPT_CODE,
            T4.DEPT_NAME AS HOS_CTF_OPER_DEPT_NAME,
            T4.DEPTOWN AS HOS_CTF_OPER_DEPT_DEPTOWN,
            T2.DEPT_CODE AS HOS_CTF_PRE_DEPT_CODE,
            T5.DEPT_NAME AS HOS_CTF_PRE_DEPT_NAME,
            T5.DEPTOWN AS HOS_CTF_PRE_DEPT_DEPTOWN,
            T2.PREDOCT_CODE AS HOS_CTF_PRE_DOC_CODE,
            T6.EMPL_NAME AS HOS_CTF_PRE_DOC_NAME,
            T6.SEX_CODE AS HOS_CTF_PRE_DOC_SEX,
            T6.BIRTHDAY AS HOS_CTF_PRE_DOC_BIRTHDAY,
            T6.IDENNO AS HOS_CTF_PRE_DOC_IDENTITY_NO,
            T6.TEL AS HOS_CTF_PRE_DOC_PHONE_NO,
            T6.EMAIL AS HOS_CTF_PRE_DOC_EMAIL,
            T6.DEPT_ID AS HOS_CTF_PRE_DOC_DEPT_CODE,
            T7.DEPT_NAME AS HOS_CTF_PRE_DOC_DEPT_NAME,
            T7.DEPTOWN AS HOS_CTF_PRE_DOC_DEPT_DEPTOWN,
            T2.CARD_NO AS HOS_CTF_PAT_CARD_NO,
            T8.GCPOUTPATIENT AS HOS_CTF_PAT_GCPOUTPATIENT,
            T8.NAME AS HOS_CTF_PAT_NAME,
            T8.SEX_CODE AS HOS_CTF_PAT_SEX,
            T8.BIRTHDAY AS HOS_CTF_PAT_BIRTHDAY,
            T8.IDENNO AS HOS_CTF_PAT_IDENTITY_NO,
            NVL(T8.WORK_TEL, NVL(T8.HOME_TEL, T8.LINKMAN_TEL)) AS HOS_CTF_PAT_PHONE_NO,
            T8.EMAIL AS HOS_CTF_PAT_EMAIL,
            T1.ESCORT_CARD_NO  AS PAT_CARD_NO,
            T9.GCPOUTPATIENT AS PAT_GCPOUTPATIENT,
            T9.NAME AS PAT_NAME,
            T9.SEX_CODE AS PAT_SEX,
            T9.BIRTHDAY AS PAT_BIRTHDAY,
            T9.IDENNO AS PAT_IDENTITY_NO,
            NVL(T9.WORK_TEL, NVL(T9.HOME_TEL, T9.LINKMAN_TEL)) AS PAT_PHONE_NO,
            T9.EMAIL AS PAT_EMAIL,
            DECODE(T10.ESCORT_CARD_NO, T1.ESCORT_CARD_NO, '1', '0') AS IS_VIP
        FROM
            KAOS.ESCORT_MAIN_INFO T1
            LEFT JOIN XYHIS.FIN_IPR_PREPAYIN T2 ON T2.CARD_NO = T1.PATIENT_CARD_NO AND T2.HAPPEN_NO = T1.HAPPEN_NO
            LEFT JOIN DAWN_ORG_EMPL T3 ON T3.EMPL_ID = T2.OPER_CODE AND T3.VALID_STATE = '1'
            LEFT JOIN DAWN_ORG_DEPT T4 ON T4.DEPT_ID = T3.DEPT_ID AND T4.VALID_STATE = '1'
            LEFT JOIN DAWN_ORG_DEPT T5 ON T5.DEPT_ID = T2.DEPT_CODE AND T5.VALID_STATE = '1'
            LEFT JOIN DAWN_ORG_EMPL T6 ON T6.EMPL_ID = T2.PREDOCT_CODE AND T6.VALID_STATE = '1'
            LEFT JOIN DAWN_ORG_DEPT T7 ON T7.DEPT_ID = T6.DEPT_ID AND T7.VALID_STATE = '1'
            LEFT JOIN COM_PATIENTINFO T8 ON T8.CARD_NO = T2.CARD_NO AND T8.IS_VALID = '1'
            LEFT JOIN COM_PATIENTINFO T9 ON T9.CARD_NO = T1.ESCORT_CARD_NO
            LEFT JOIN KAOS.ESCORT_VIP T10 ON T10.PATIENT_CARD_NO = T1.PATIENT_CARD_NO AND T10.HAPPEN_NO = T1.HAPPEN_NO
        WHERE
            T1.ESCORT_NO = #{escortNo}
    </select>

    <select id="GetEscortsByHelperCardNo" resultMap="resultMap">
        SELECT
            T1.ESCORT_NO AS ESCORT_NO,
            T1.PATIENT_CARD_NO AS HOS_CTF_CARD_NO,
            T1.HAPPEN_NO AS HOS_CTF_HAPPEN_NO,
            T2.OPER_DATE AS HOS_CTF_OPER_DATE,
            T2.NURSE_CELL_CODE AS HOS_CTF_PRE_NURSE_CELL_CODE,
            T2.BED_NO AS HOS_CTF_PRE_BED_NO,
            T2.PRE_DATE AS HOS_CTF_PRE_DATE,
            T2.PREPAY_COST AS HOS_CTF_PRE_COST,
            T2.PRE_STATE AS HOS_CTF_STATE,
            T2.OPER_CODE AS HOS_CTF_OPER_CODE,
            T3.EMPL_NAME AS HOS_CTF_OPER_NAME,
            T3.SEX_CODE AS HOS_CTF_OPER_SEX,
            T3.BIRTHDAY AS HOS_CTF_OPER_BIRTHDAY,
            T3.IDENNO AS HOS_CTF_OPER_IDENTITY_NO,
            T3.TEL AS HOS_CTF_OPER_PHONE_NO,
            T3.EMAIL AS HOS_CTF_OPER_EMAIL,
            T3.DEPT_ID AS HOS_CTF_OPER_DEPT_CODE,
            T4.DEPT_NAME AS HOS_CTF_OPER_DEPT_NAME,
            T4.DEPTOWN AS HOS_CTF_OPER_DEPT_DEPTOWN,
            T2.DEPT_CODE AS HOS_CTF_PRE_DEPT_CODE,
            T5.DEPT_NAME AS HOS_CTF_PRE_DEPT_NAME,
            T5.DEPTOWN AS HOS_CTF_PRE_DEPT_DEPTOWN,
            T2.PREDOCT_CODE AS HOS_CTF_PRE_DOC_CODE,
            T6.EMPL_NAME AS HOS_CTF_PRE_DOC_NAME,
            T6.SEX_CODE AS HOS_CTF_PRE_DOC_SEX,
            T6.BIRTHDAY AS HOS_CTF_PRE_DOC_BIRTHDAY,
            T6.IDENNO AS HOS_CTF_PRE_DOC_IDENTITY_NO,
            T6.TEL AS HOS_CTF_PRE_DOC_PHONE_NO,
            T6.EMAIL AS HOS_CTF_PRE_DOC_EMAIL,
            T6.DEPT_ID AS HOS_CTF_PRE_DOC_DEPT_CODE,
            T7.DEPT_NAME AS HOS_CTF_PRE_DOC_DEPT_NAME,
            T7.DEPTOWN AS HOS_CTF_PRE_DOC_DEPT_DEPTOWN,
            T2.CARD_NO AS HOS_CTF_PAT_CARD_NO,
            T8.GCPOUTPATIENT AS HOS_CTF_PAT_GCPOUTPATIENT,
            T8.NAME AS HOS_CTF_PAT_NAME,
            T8.SEX_CODE AS HOS_CTF_PAT_SEX,
            T8.BIRTHDAY AS HOS_CTF_PAT_BIRTHDAY,
            T8.IDENNO AS HOS_CTF_PAT_IDENTITY_NO,
            NVL(T8.WORK_TEL, NVL(T8.HOME_TEL, T8.LINKMAN_TEL)) AS HOS_CTF_PAT_PHONE_NO,
            T8.EMAIL AS HOS_CTF_PAT_EMAIL,
            T1.ESCORT_CARD_NO  AS PAT_CARD_NO,
            T9.GCPOUTPATIENT AS PAT_GCPOUTPATIENT,
            T9.NAME AS PAT_NAME,
            T9.SEX_CODE AS PAT_SEX,
            T9.BIRTHDAY AS PAT_BIRTHDAY,
            T9.IDENNO AS PAT_IDENTITY_NO,
            NVL(T9.WORK_TEL, NVL(T9.HOME_TEL, T9.LINKMAN_TEL)) AS PAT_PHONE_NO,
            T9.EMAIL AS PAT_EMAIL,
            DECODE(T10.ESCORT_CARD_NO, T1.ESCORT_CARD_NO, '1', '0') AS IS_VIP
        FROM
            KAOS.ESCORT_MAIN_INFO T1
            LEFT JOIN XYHIS.FIN_IPR_PREPAYIN T2 ON T2.CARD_NO = T1.PATIENT_CARD_NO AND T2.HAPPEN_NO = T1.HAPPEN_NO
            LEFT JOIN DAWN_ORG_EMPL T3 ON T3.EMPL_ID = T2.OPER_CODE AND T3.VALID_STATE = '1'
            LEFT JOIN DAWN_ORG_DEPT T4 ON T4.DEPT_ID = T3.DEPT_ID AND T4.VALID_STATE = '1'
            LEFT JOIN DAWN_ORG_DEPT T5 ON T5.DEPT_ID = T2.DEPT_CODE AND T5.VALID_STATE = '1'
            LEFT JOIN DAWN_ORG_EMPL T6 ON T6.EMPL_ID = T2.PREDOCT_CODE AND T6.VALID_STATE = '1'
            LEFT JOIN DAWN_ORG_DEPT T7 ON T7.DEPT_ID = T6.DEPT_ID AND T7.VALID_STATE = '1'
            LEFT JOIN COM_PATIENTINFO T8 ON T8.CARD_NO = T2.CARD_NO AND T8.IS_VALID = '1'
            LEFT JOIN COM_PATIENTINFO T9 ON T9.CARD_NO = T1.ESCORT_CARD_NO
            LEFT JOIN KAOS.ESCORT_VIP T10 ON T10.PATIENT_CARD_NO = T1.PATIENT_CARD_NO AND T10.HAPPEN_NO = T1.HAPPEN_NO
        WHERE
            T1.ESCORT_CARD_NO = #{cardNo}
        ORDER BY
            T1.ESCORT_NO
    </select>

    <select id="GetEscortsByPatientCardNoAndHappenNo" resultMap="resultMap">
        SELECT
            T1.ESCORT_NO AS ESCORT_NO,
            T1.PATIENT_CARD_NO AS HOS_CTF_CARD_NO,
            T1.HAPPEN_NO AS HOS_CTF_HAPPEN_NO,
            T2.OPER_DATE AS HOS_CTF_OPER_DATE,
            T2.NURSE_CELL_CODE AS HOS_CTF_PRE_NURSE_CELL_CODE,
            T2.BED_NO AS HOS_CTF_PRE_BED_NO,
            T2.PRE_DATE AS HOS_CTF_PRE_DATE,
            T2.PREPAY_COST AS HOS_CTF_PRE_COST,
            T2.PRE_STATE AS HOS_CTF_STATE,
            T2.OPER_CODE AS HOS_CTF_OPER_CODE,
            T3.EMPL_NAME AS HOS_CTF_OPER_NAME,
            T3.SEX_CODE AS HOS_CTF_OPER_SEX,
            T3.BIRTHDAY AS HOS_CTF_OPER_BIRTHDAY,
            T3.IDENNO AS HOS_CTF_OPER_IDENTITY_NO,
            T3.TEL AS HOS_CTF_OPER_PHONE_NO,
            T3.EMAIL AS HOS_CTF_OPER_EMAIL,
            T3.DEPT_ID AS HOS_CTF_OPER_DEPT_CODE,
            T4.DEPT_NAME AS HOS_CTF_OPER_DEPT_NAME,
            T4.DEPTOWN AS HOS_CTF_OPER_DEPT_DEPTOWN,
            T2.DEPT_CODE AS HOS_CTF_PRE_DEPT_CODE,
            T5.DEPT_NAME AS HOS_CTF_PRE_DEPT_NAME,
            T5.DEPTOWN AS HOS_CTF_PRE_DEPT_DEPTOWN,
            T2.PREDOCT_CODE AS HOS_CTF_PRE_DOC_CODE,
            T6.EMPL_NAME AS HOS_CTF_PRE_DOC_NAME,
            T6.SEX_CODE AS HOS_CTF_PRE_DOC_SEX,
            T6.BIRTHDAY AS HOS_CTF_PRE_DOC_BIRTHDAY,
            T6.IDENNO AS HOS_CTF_PRE_DOC_IDENTITY_NO,
            T6.TEL AS HOS_CTF_PRE_DOC_PHONE_NO,
            T6.EMAIL AS HOS_CTF_PRE_DOC_EMAIL,
            T6.DEPT_ID AS HOS_CTF_PRE_DOC_DEPT_CODE,
            T7.DEPT_NAME AS HOS_CTF_PRE_DOC_DEPT_NAME,
            T7.DEPTOWN AS HOS_CTF_PRE_DOC_DEPT_DEPTOWN,
            T2.CARD_NO AS HOS_CTF_PAT_CARD_NO,
            T8.GCPOUTPATIENT AS HOS_CTF_PAT_GCPOUTPATIENT,
            T8.NAME AS HOS_CTF_PAT_NAME,
            T8.SEX_CODE AS HOS_CTF_PAT_SEX,
            T8.BIRTHDAY AS HOS_CTF_PAT_BIRTHDAY,
            T8.IDENNO AS HOS_CTF_PAT_IDENTITY_NO,
            NVL(T8.WORK_TEL, NVL(T8.HOME_TEL, T8.LINKMAN_TEL)) AS HOS_CTF_PAT_PHONE_NO,
            T8.EMAIL AS HOS_CTF_PAT_EMAIL,
            T1.ESCORT_CARD_NO  AS PAT_CARD_NO,
            T9.GCPOUTPATIENT AS PAT_GCPOUTPATIENT,
            T9.NAME AS PAT_NAME,
            T9.SEX_CODE AS PAT_SEX,
            T9.BIRTHDAY AS PAT_BIRTHDAY,
            T9.IDENNO AS PAT_IDENTITY_NO,
            NVL(T9.WORK_TEL, NVL(T9.HOME_TEL, T9.LINKMAN_TEL)) AS PAT_PHONE_NO,
            T9.EMAIL AS PAT_EMAIL,
            DECODE(T10.ESCORT_CARD_NO, T1.ESCORT_CARD_NO, '1', '0') AS IS_VIP
        FROM
            KAOS.ESCORT_MAIN_INFO T1
            LEFT JOIN XYHIS.FIN_IPR_PREPAYIN T2 ON T2.CARD_NO = T1.PATIENT_CARD_NO AND T2.HAPPEN_NO = T1.HAPPEN_NO
            LEFT JOIN DAWN_ORG_EMPL T3 ON T3.EMPL_ID = T2.OPER_CODE AND T3.VALID_STATE = '1'
            LEFT JOIN DAWN_ORG_DEPT T4 ON T4.DEPT_ID = T3.DEPT_ID AND T4.VALID_STATE = '1'
            LEFT JOIN DAWN_ORG_DEPT T5 ON T5.DEPT_ID = T2.DEPT_CODE AND T5.VALID_STATE = '1'
            LEFT JOIN DAWN_ORG_EMPL T6 ON T6.EMPL_ID = T2.PREDOCT_CODE AND T6.VALID_STATE = '1'
            LEFT JOIN DAWN_ORG_DEPT T7 ON T7.DEPT_ID = T6.DEPT_ID AND T7.VALID_STATE = '1'
            LEFT JOIN COM_PATIENTINFO T8 ON T8.CARD_NO = T2.CARD_NO AND T8.IS_VALID = '1'
            LEFT JOIN COM_PATIENTINFO T9 ON T9.CARD_NO = T1.ESCORT_CARD_NO
            LEFT JOIN KAOS.ESCORT_VIP T10 ON T10.PATIENT_CARD_NO = T1.PATIENT_CARD_NO AND T10.HAPPEN_NO = T1.HAPPEN_NO
        WHERE
            T1.PATIENT_CARD_NO = #{cardNo}
            AND T1.HAPPEN_NO = #{happenNo}
        ORDER BY
            T1.ESCORT_NO
    </select>

    <select id="GetEscortStates" resultMap="escortStateMap">
        SELECT
            T1.REC_NO AS REC_NO,
            T1.STATE AS STATE,
            T1.OPER_DATE AS OPER_DATE
        FROM
            KAOS.ESCORT_STATE_REC T1
        WHERE
            T1.ESCORT_NO = #{escortNo}
    </select>

    <select id="GetEscortActions" resultMap="escortActionMap">
        SELECT
            T1.REC_NO AS REC_NO,
            T1.ACTION AS STATE,
            T1.OPER_DATE AS OPER_DATE
        FROM
            KAOS.ESCORT_ACTION_REC T1
        WHERE
            T1.ESCORT_NO = #{escortNo}
    </select>
</mapper>